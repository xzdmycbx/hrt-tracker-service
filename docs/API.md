# HRT Tracker Service - API 文档

## 项目概述

HRT Tracker Service 是一个专为 HRT（激素替代治疗）追踪设计的安全后端服务。

### 核心功能

#### 1. 用户认证系统
- **注册与登录**：用户可以注册账号并登录系统
- **双令牌机制**：采用 `access_token` 和 `refresh_token` 进行身份验证
  - Access Token：用于所有需要认证的 API 请求
  - Refresh Token：用于刷新 Access Token，延长登录状态

#### 2. 数据加密与安全密码
- **账户数据**：每个用户拥有一份账户数据（JSON 格式）
- **6位安全密码**：用户可选择设置 6 位数字的安全密码
  - 安全密码使用 PBKDF2 + Salt 进行哈希存储
  - 设置安全密码后，用户数据将使用 AES-256-GCM 加密
  - 获取数据时需要提供安全密码进行解密
- **密码用途区分**：
  - 登录密码：用于身份认证（注册、登录）
  - 安全密码：仅用于数据加密/解密，不用于其他敏感操作验证

#### 3. 数据分享功能
用户可以创建两种类型的数据分享：

- **实时分享（Realtime）**
  - 始终同步显示用户当前的最新数据
  - 每个用户只能创建 1 个实时分享

- **副本分享（Copy）**
  - 创建时的数据快照，不会随用户数据更新而变化
  - 可创建无限个副本分享

**分享密码保护**：
- 可为每个分享独立设置 6 位数字密码（可选）
- 支持无密码公开分享
- 防暴力破解：密码保护的分享默认最多尝试 5 次，失败后锁定

**分享管理**：
- 删除分享
- 修改分享密码
- 查看访问统计（查看次数、密码尝试次数）
- 自定义锁定规则（如：密码尝试 5 次失败后锁定）

**重要限制**：
- 加密数据无法通过分享功能共享（需先解除加密）

#### 4. 授权访问系统
- **直接授权**：用户可以授权其他用户直接查看自己的数据
- **查看要求**：被授权用户查看数据时，需要输入**自己的**安全密码（非所有者密码）
- **永久授权**：授权关系永久有效，除非主动撤销
- **授权管理**：
  - 查看已授权的用户列表
  - 查看授权我访问的用户列表
  - 撤销对某用户的授权

**重要限制**：
- 无法查看已加密的所有者数据

---

## 基础信息

### Base URL
```
http://localhost:8080/api
```

### 认证方式

大多数接口需要在请求头中携带 Bearer Token：
```
Authorization: Bearer <access_token>
```

---

## 响应格式

所有 API 响应遵循统一结构：

### 成功响应
```json
{
  "success": true,
  "message": "可选的成功消息",
  "data": { /* 响应数据 */ }
}
```

### 错误响应
```json
{
  "success": false,
  "error": "错误消息"
}
```

---

## 接口列表

### 1. 认证相关

#### 1.1 用户注册
创建新用户账号。

**接口：** `POST /auth/register`

**需要认证：** 否

**请求体：**
```json
{
  "username": "string (3-20位字母、数字或下划线)",
  "password": "string (最少6位)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "access_token": "访问令牌",
    "refresh_token": "刷新令牌",
    "expires_in": 3600
  }
}
```

**错误响应：**
- `400` - 请求体无效 / 用户名已存在 / 用户名格式错误 / 密码太短
- `500` - 服务器内部错误（生成盐值、创建用户或生成令牌失败）

**说明：**
- `expires_in` 字段显示访问令牌的过期时间（秒），由环境变量 `ACCESS_TOKEN_EXPIRE_HOURS` 配置，默认为 3600 秒（1小时）。
- 刷新令牌默认长期有效，直到用户修改登录密码，或通过注销/踢出操作使令牌失效。

---

#### 1.2 用户登录
验证用户身份并获取访问令牌。

**接口：** `POST /auth/login`

**需要认证：** 否

**请求体：**
```json
{
  "username": "string",
  "password": "string"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "access_token": "访问令牌",
    "refresh_token": "刷新令牌",
    "expires_in": 3600
  }
}
```

**错误响应：**
- `400` - 请求体无效
- `401` - 用户名或密码错误
- `500` - 服务器内部错误（密码格式错误或生成令牌失败）

**说明：**
- `expires_in` 字段显示访问令牌的过期时间（秒），由环境变量 `ACCESS_TOKEN_EXPIRE_HOURS` 配置。

---

#### 1.3 刷新令牌
使用刷新令牌获取新的访问令牌。

**接口：** `POST /auth/refresh`

**需要认证：** 否

**请求体：**
```json
{
  "refresh_token": "string"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "access_token": "新访问令牌",
    "refresh_token": "新刷新令牌",
    "expires_in": 3600
  }
}
```

**错误响应：**
- `400` - 请求体无效
- `401` - 刷新令牌无效或已被注销
- `500` - 服务器内部错误（生成令牌失败）

**说明：**
- 使用刷新令牌后，旧的刷新令牌将被删除，只有新的刷新令牌有效。
- 刷新令牌长期有效，直到用户修改登录密码，或通过注销/踢出操作使令牌失效。
- `expires_in` 字段显示访问令牌的过期时间（秒），由环境变量 `ACCESS_TOKEN_EXPIRE_HOURS` 配置。

---

#### 1.4 注销当前登录
注销当前设备的登录状态（使当前 refresh token 失效）。

**接口：** `POST /auth/logout`

**需要认证：** 是

**请求体：** 无

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "Logged out successfully",
  "data": {
    "revoked_count": 1
  }
}
```

**错误响应：**
- `401` - 未授权（令牌无效）
- `500` - 服务器内部错误

**说明：**
- 该接口会删除当前会话对应的 refresh token，使其无法再用于刷新 access token。

---

#### 1.5 获取登录会话列表
查看当前用户在所有设备上的登录会话。

**接口：** `GET /auth/sessions`

**需要认证：** 是

**请求体：** 无

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "current_session_id": "550e8400-e29b-41d4-a716-446655440000",
    "sessions": [
      {
        "session_id": "550e8400-e29b-41d4-a716-446655440000",
        "device_info": "Chrome on Windows 10",
        "ip_address": "192.168.1.100",
        "created_at": "2024-01-01T10:00:00Z",
        "last_used_at": "2024-01-02T15:30:00Z",
        "is_current": true
      },
      {
        "session_id": "660f9511-f3ac-52e5-b827-557766551111",
        "device_info": "Safari on iPhone",
        "ip_address": "192.168.1.101",
        "created_at": "2023-12-31T20:00:00Z",
        "last_used_at": "2024-01-01T12:00:00Z",
        "is_current": false
      }
    ]
  }
}
```

**错误响应：**
- `401` - 未授权（令牌无效）
- `429` - 请求过于频繁（限流：150次/分钟）
- `500` - 服务器内部错误

**说明：**
- `current_session_id`：当前请求使用的会话ID
- `is_current`：标记是否为当前设备，防止误踢自己
- `last_used_at`：每次刷新令牌时更新
- **限流**：150次/分钟，超限后锁定5分钟

---

#### 1.6 踢出指定设备
撤销指定设备的登录状态（删除其 Refresh Token）。

**接口：** `DELETE /auth/sessions/:session_id`

**需要认证：** 是

**URL 参数：**
- `session_id`：要踢出的会话ID（从 `GET /auth/sessions` 获取）

**请求体：**
```json
{
  "password": "your_login_password"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "会话已撤销"
}
```

**错误响应：**
- `400` - 请求体无效 / 不能踢出当前设备
- `401` - 未授权（令牌无效或登录密码错误）
- `404` - 会话不存在
- `429` - 请求过于频繁（限流：50次/5分钟）
- `500` - 服务器内部错误

**说明：**
- **安全验证**：需要提供**登录密码**（非安全密码），所有用户都可使用
- **保护机制**：不允许踢出当前设备，防止误操作
- **限流**：50次/5分钟，超限后锁定15分钟

---

#### 1.7 踢出所有其他设备
撤销除当前设备外的所有登录状态。

**接口：** `DELETE /auth/sessions`

**需要认证：** 是

**请求体：**
```json
{
  "password": "your_login_password"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "其他会话已撤销",
  "data": {
    "revoked_count": 2
  }
}
```

**错误响应：**
- `400` - 请求体无效
- `401` - 未授权（令牌无效或登录密码错误）
- `429` - 请求过于频繁（限流：25次/5分钟）
- `500` - 服务器内部错误

**说明：**
- **安全验证**：需要提供**登录密码**（非安全密码）
- **批量操作**：删除除当前设备外的所有 refresh token
- **限流**：25次/5分钟，超限后锁定15分钟
- `revoked_count`：实际撤销的会话数量

---

### 2. 用户数据管理

#### 2.1 设置安全密码
首次设置6位数字安全密码。此密码用于加密用户数据。

**重要：** 如果已设置安全密码，必须使用 `PUT /user/security-password` 接口更新。

**接口：** `POST /user/security-password`

**需要认证：** 是

**请求体：**
```json
{
  "password": "string (必须是6位数字)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "安全密码设置成功"
}
```

**错误响应：**
- `400` - 请求体无效 / 密码必须是6位数字 / 安全密码已存在（需使用 PUT 更新）
- `401` - 未授权（令牌无效）
- `404` - 用户不存在
- `500` - 服务器内部错误（生成盐值或加密数据失败）

**说明：**
- 此接口仅用于首次设置安全密码。
- 如果用户数据存在且未加密，将自动使用新密码加密。
- 如果已设置安全密码，将返回 400 错误。

---

#### 2.2 修改安全密码
修改安全密码。需要提供旧密码。

**接口：** `PUT /user/security-password`

**需要认证：** 是

**请求体：**
```json
{
  "old_password": "string (6位数字)",
  "new_password": "string (6位数字)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "安全密码更新成功"
}
```

**错误响应：**
- `400` - 请求体无效 / 密码必须是6位数字 / 未设置安全密码
- `401` - 未授权（令牌无效或旧密码错误）
- `404` - 用户不存在
- `500` - 服务器内部错误（生成盐值、解密或重新加密数据失败）

**说明：**
- 所有已加密的数据将使用新密码重新加密。

---

#### 2.3 查询安全密码状态
检查用户是否已设置安全密码。

**接口：** `GET /user/security-password/status`

**需要认证：** 是

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "has_security_password": true
  }
}
```

**错误响应：**
- `401` - 未授权
- `404` - 用户不存在

---

#### 2.4 获取用户数据
获取用户的 JSON 数据。

**接口：** `POST /user/data`

**需要认证：** 是

**请求体：**
```json
{
  "password": "string (6位数字，如果数据已加密则必填)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "data": { /* 用户的 JSON 数据，无数据时为 null */ },
    "is_encrypted": true
  }
}
```

**错误响应：**
- `400` - 需要安全密码（数据已加密但未提供密码）
- `401` - 未授权 / 安全密码错误
- `404` - 用户不存在
- `429` - 请求过于频繁（限流：200次/分钟）
- `500` - 服务器内部错误（解密或解析数据失败）

**说明：**
- 如果 `is_encrypted` 为 `false`，则不需要提供 `password` 字段。
- 如果 `is_encrypted` 为 `true`，必须提供安全密码。
- 如果用户未存储数据，`data` 字段将为 `null`。
- **限流**：200次/分钟，超限后锁定5分钟

---

#### 2.5 更新用户数据
更新用户的 JSON 数据。

**接口：** `PUT /user/data`

**需要认证：** 是

**请求体：**
```json
{
  "password": "string (6位数字，如果已设置安全密码则必填)",
  "data": { /* 任意 JSON 对象 */ }
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "数据更新成功"
}
```

**错误响应：**
- `400` - 请求体无效 / 需要安全密码
- `401` - 未授权 / 安全密码错误
- `404` - 用户不存在
- `429` - 请求过于频繁（限流：100次/分钟）
- `500` - 服务器内部错误（序列化或加密数据失败）

**说明：**
- 如果用户已设置安全密码，`password` 字段为必填。
- 如果设置了安全密码，数据将自动加密。
- **限流**：100次/分钟，超限后锁定5分钟

---

### 3. 分享管理

#### 3.1 创建分享
创建新的数据分享（实时同步或快照副本）。

**接口：** `POST /shares`

**需要认证：** 是

**请求体：**
```json
{
  "share_type": "realtime|copy",
  "password": "string (6位数字，可选)",
  "max_attempts": "number (可选，默认：有密码时为5，无密码时为0)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "share_id": "string (32位十六进制字符)",
    "share_type": "realtime|copy"
  }
}
```

**错误响应：**
- `400` - 请求体无效 / 分享类型无效 / 密码必须是6位数字 / max_attempts 不能为负数 / 实时分享已存在 / 无法创建包含加密数据的副本分享
- `401` - 未授权
- `500` - 服务器内部错误（生成盐值或创建分享失败）

**说明：**
- `share_type` 类型：
  - `"realtime"` - 始终显示当前用户数据（每个用户只能创建一个）
  - `"copy"` - 显示创建时的数据快照（无限制）
- 每个用户只能创建一个实时分享。
- 如果不提供 `password`，分享将是公开的（无需密码即可查看）。
- **重要：** 如果设置了 `password` 但未设置 `max_attempts`（或设置为 0），系统将自动设为 5 次尝试以防止暴力破解。
- `max_attempts` 不能为负数。
- 无法创建包含加密数据的副本分享。实时分享也无法显示加密数据。

---

#### 3.2 获取我的分享列表
获取当前用户创建的所有分享。

**接口：** `GET /shares`

**需要认证：** 是

**成功响应 (200)：**
```json
{
  "success": true,
  "data": [
    {
      "share_id": "string",
      "share_type": "realtime|copy",
      "has_password": true,
      "view_count": 10,
      "attempt_count": 3,
      "max_attempts": 5,
      "is_locked": false,
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

**错误响应：**
- `401` - 未授权

---

#### 3.3 删除分享
删除一个分享。

**接口：** `DELETE /shares/:share_id`

**需要认证：** 是

**URL 参数：**
- `share_id` - 要删除的分享ID

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "分享删除成功"
}
```

**错误响应：**
- `401` - 未授权
- `404` - 分享不存在

---

#### 3.4 修改分享密码
更新或移除分享的密码。

**接口：** `PUT /shares/:share_id/password`

**需要认证：** 是

**URL 参数：**
- `share_id` - 分享ID

**请求体：**
```json
{
  "password": "string (6位数字，空字符串表示移除密码)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "分享密码更新成功"
}
```

**错误响应：**
- `400` - 请求体无效 / 密码必须是6位数字
- `401` - 未授权
- `404` - 分享不存在

**说明：**
- 更新密码会重置锁定状态和尝试次数。
- 设置 `password` 为空字符串可移除密码保护。

---

#### 3.5 修改分享锁定设置
更新分享的最大尝试次数限制。

**接口：** `PUT /shares/:share_id/lock`

**需要认证：** 是

**URL 参数：**
- `share_id` - 分享ID

**请求体：**
```json
{
  "max_attempts": "number (不能为负数，0表示无限制)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "分享锁定设置更新成功"
}
```

**错误响应：**
- `400` - 请求体无效 / max_attempts 不能为负数
- `401` - 未授权
- `404` - 分享不存在

**说明：**
- 更新锁定设置会重置锁定状态和尝试次数。
- 设置为 `0` 表示无限制尝试。
- `max_attempts` 不能为负数。

---

#### 3.6 查看分享内容
查看分享的数据（公开接口）。

**接口：** `POST /shares/:share_id/view`

**需要认证：** 否

**URL 参数：**
- `share_id` - 分享ID

**请求体：**
```json
{
  "password": "string (6位数字，如果分享设置了密码则必填)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "data": { /* 分享的 JSON 数据 */ },
    "share_type": "realtime|copy"
  }
}
```

**错误响应：**
- `400` - 需要密码（分享已设置密码保护）
- `401` - 密码错误
- `403` - 分享已锁定 / 所有者的数据已加密
- `404` - 分享不存在
- `500` - 服务器内部错误（解析数据失败）

**说明：**
- 每次成功查看（包括返回空数据的查看）都会增加 `view_count`。
- 每次密码验证失败（包括未提供密码）都会增加 `attempt_count`。
- 如果 `attempt_count` 达到 `max_attempts`，分享将被锁定。
- 实时分享无法显示已加密的所有者数据。
- 副本分享无法在创建时包含加密数据。

---

### 4. 授权管理

#### 4.1 授权其他用户
授权另一个用户查看你的数据。

**接口：** `POST /authorizations`

**需要认证：** 是

**请求体：**
```json
{
  "viewer_username": "string"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "授权成功",
  "data": {
    "viewer_username": "string"
  }
}
```

**错误响应：**
- `400` - 请求体无效 / 授权已存在
- `401` - 未授权
- `404` - 查看者用户不存在
- `500` - 服务器内部错误（创建授权失败）

---

#### 4.2 撤销授权
撤销对某用户的授权。

**接口：** `DELETE /authorizations/:viewer_username`

**需要认证：** 是

**URL 参数：**
- `viewer_username` - 要撤销授权的用户名

**成功响应 (200)：**
```json
{
  "success": true,
  "message": "授权撤销成功"
}
```

**错误响应：**
- `401` - 未授权
- `404` - 查看者用户不存在 / 授权不存在

---

#### 4.3 获取我授权的用户列表
获取你已授权的所有用户列表。

**接口：** `GET /authorizations/granted`

**需要认证：** 是

**成功响应 (200)：**
```json
{
  "success": true,
  "data": [
    {
      "viewer_username": "string",
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

**错误响应：**
- `401` - 未授权

---

#### 4.4 获取授权我的用户列表
获取已授权你查看其数据的所有用户列表。

**接口：** `GET /authorizations/received`

**需要认证：** 是

**成功响应 (200)：**
```json
{
  "success": true,
  "data": [
    {
      "owner_username": "string",
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

**错误响应：**
- `401` - 未授权

---

#### 4.5 查看已授权的数据
查看已授权你的用户的数据。

**接口：** `POST /authorizations/view`

**需要认证：** 是

**请求体：**
```json
{
  "owner_username": "string",
  "password": "string (你自己的6位数字安全密码)"
}
```

**成功响应 (200)：**
```json
{
  "success": true,
  "data": {
    "data": { /* 所有者的 JSON 数据，无数据时为 null */ },
    "owner": "string",
    "is_encrypted": false
  }
}
```

**错误响应：**
- `400` - 请求体无效 / 你必须先设置安全密码
- `401` - 未授权 / 安全密码错误
- `403` - 未被授权查看 / 所有者的数据已加密
- `404` - 所有者用户不存在 / 查看者不存在
- `500` - 服务器内部错误（解析数据失败）

**说明：**
- 你必须提供**你自己的**安全密码来查看已授权的数据。
- 无法查看已加密其数据的所有者的数据。
- 如果所有者未存储数据，`data` 字段将为 `null`。

---

## 错误码说明

- `400` - 错误请求（输入无效）
- `401` - 未授权（凭据或令牌无效）
- `403` - 禁止访问（分享已锁定、无权限、数据已加密）
- `404` - 未找到（资源不存在）
- `500` - 服务器内部错误

---

## 安全说明

1. **访问令牌（Access Token）**：默认1小时过期。用于受保护接口的 Authorization 请求头。
2. **刷新令牌（Refresh Token）**：默认长期有效，直到用户修改登录密码或通过注销/踢出操作使其失效。用于获取新的访问令牌。
3. **安全密码（Security Password）**：6位数字密码，用于：
   - 加密/解密你自己的数据
   - 查看已授权数据时验证身份
4. **分享密码（Share Password）**：可选的6位数字密码，用于控制分享访问。
5. **密码存储**：所有密码使用 PBKDF2 + 盐值进行哈希存储。
6. **数据加密**：使用 AES-256-GCM 加密用户数据。

---

## 使用流程示例

### 示例 1：注册并设置账号
```
1. POST /auth/register { username, password }
   → 获得 access_token 和 refresh_token

2. POST /user/security-password { password: "123456" }
   → 设置安全密码

3. PUT /user/data { password: "123456", data: {...} }
   → 存储加密数据
```

### 示例 2：创建并分享数据
```
1. POST /shares { share_type: "copy", password: "654321" }
   → 获得 share_id

2. 将 share_id 分享给他人

3. 他人访问：POST /shares/:share_id/view { password: "654321" }
   → 查看你的数据快照
```

### 示例 3：授权其他用户
```
1. POST /authorizations { viewer_username: "friend" }
   → 授予授权

2. 朋友访问：POST /authorizations/view { owner_username: "you", password: "their_password" }
   → 朋友可以查看你的数据（如果未加密）
```

---

## 健康检查

**接口：** `GET /health`

**需要认证：** 否

**成功响应 (200)：**
```json
{
  "status": "ok"
}
```
